{% load upload_tags %}
{% load staticfiles %}

{% block content %}

<!--<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">-->
<link rel="stylesheet" href="{% static 'css/blueimp-gallery.min.css'%}">
<link rel="stylesheet" href="{% static 'css/jquery.fileupload-ui.css' %}">
<noscript><link rel="stylesheet" href="{% static 'css/jquery.fileupload-ui-noscript.css' %}"></noscript>

<style>
.preview img {
    max-height:50px;
}
</style>

<div class="">
    <!-- The file upload form used as target for the file upload widget -->
    <form id="fileupload" method="post" action="{%url 'upload-new'%}" enctype="multipart/form-data">{% csrf_token %}
        <!-- Redirect browsers with JavaScript disabled to the origin page -->
        <!--<noscript><input type="hidden" name="redirect" value="http://blueimp.github.io/jQuery-File-Upload/"></noscript>-->
        <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
        <div class="row fileupload-buttonbar">
            <div class="col-lg-12">
                <!-- The fileinput-button span is used to style the file input field as button -->
                <span class="btn btn-success fileinput-button">
                    <i class="glyphicon glyphicon-plus"></i>
                    <span>Agregar Archivos...</span>
                    <input type="file" name="file" multiple>
                </span>
                <button type="submit" class="btn btn-primary start">
                    <i class="glyphicon glyphicon-upload"></i>
                    <span>Cargar</span>
                </button>
                <button type="reset" class="btn btn-warning cancel">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>Cancelar</span>
                </button>
                <button type="button" class="btn btn-danger delete">
                    <i class="glyphicon glyphicon-trash"></i>
                    <span>Eliminar</span>
                </button>
                <input type="checkbox" class="toggle">
                <!-- The loading indicator is shown during file processing -->
                <span class="fileupload-loading"></span>
            </div>
            <!-- The global progress information -->
            <div class="col-lg-12 fileupload-progress fade">
                <!-- The global progress bar -->
                <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar progress-bar-success" style="width:0%;"></div>
                </div>
                <!-- The extended global progress information -->
                <div class="progress-extended">&nbsp;</div>
            </div>
        </div>
        <!-- The table listing the files available for upload/download -->
        <table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>
    </form>
    <br>
</div>

<div class="videos">
    <form id="videos" method="post" action="" enctype="" name="_video">{% csrf_token %}
        <div class="row">
            <div class="col-lg-12">
                 <button type="button" class="btn btn-success add-video">
                    <i class="glyphicon glyphicon-plus"></i>
                    <span>Agregar URL de video</span>
                </button>
                <button type="button" class="btn btn-danger delete">
                    <i class="glyphicon glyphicon-trash"></i>
                    <span>Eliminar</span>
                </button>
                <input type="checkbox" class="toggle">
            </div>
            <div class="col-lg-12  content-video">
                <table class="table table-striped table-videos ">
                    <tbody>
                        {% if videos %}
                        {% for v in videos%}
                            <tr>
                                <td class="td-video">
                                    <input class="url-video form-control">
                                </td>
                                <td>
                                    <iframe width="100" height="75" src="" frameborder="0"></iframe>
                                </td>
                                <td>
                                    <button class="btn btn-primary start">
                                        <i class="glyphicon glyphicon-upload"></i><span>Cargar</span>
                                    </button>
                                    <button class="btn btn-warning cancel">
                                        <i class="glyphicon glyphicon-ban-circle"></i>
                                        <span>Cancelar</span>
                                    </button>
                                </td>
                                <td class ="hidden">
                                    <button type="button" class="btn btn-danger delete">
                                        <i class="glyphicon glyphicon-trash"></i><span>Borrar</span>
                                    </button>
                                    <input type="checkbox" class="toggle">
                                </td>
                            </tr>
                            {%endfor%}
                        {%endif%}
                    </tbody>
                    <!--<colgroup><col width="60%"/><col width="30%"/></colgroup>-->
                </table>

            </div>
        </div>
    </form>
</div>
<!-- The blueimp Gallery widget -->
<div id="blueimp-gallery" class="blueimp-gallery blueimp-gallery-controls" data-filter=":even">
    <div class="slides"></div>
    <h3 class="title"></h3>
    <a class="prev">‹</a>
    <a class="next">›</a>
    <a class="close">×</a>
    <a class="play-pause"></a>
    <ol class="indicator"></ol>
</div>
{% upload_js %}
<script>
    $(function(){
        $("#form-modal .modal-title").html('Selección de imágenes y videos');
        debugger;
        $.ajax({
                type:"GET",
                url:"{%url 'empresa-video-list' %}",
                //data: form,
                processData: false,
                contentType: false,
                error: function(x){
                    console.log(x.responseText);
                },
                success: function(data){
                    $(data).each(function(index, el) {
                        var url_frame =  data[index].fields.url.replace('watch?v=', 'embed/') + '?rel=0';
                        debugger;
                         $(".table-videos > tbody:last-child").append('' +
                                 '<tr data-id="'+data[index].pk+'">' +
                                 '<td class="td-video"><input class="url-video form-control" value='+data[index].fields.url+'></td>' +
                                 '<td><iframe width="100" height="75" src="'+url_frame+'" frameborder="0"></iframe></td>' +
                                 '<td><button type="button" class="btn btn-danger delete">' +
                                 '<i class="glyphicon glyphicon-trash"></i><span>Borrar</span></button>' +
                                 '<input type="checkbox" class="toggle"></td></tr>');
                    });
                },
            });

    })
</script>
<script src="{% static 'js/jquery-ui-1.10.3.custom.min.js' %}"></script>
<script src="{% static 'js/tmpl.min.js' %}"></script>
<script src="{% static 'js/load-image.min.js' %}"></script>
<script src="{% static 'js/canvas-to-blob.min.js' %}"></script>
<script src="{% static 'js/jquery.blueimp-gallery.min.js'%}"></script>
<script src="{% static 'js/jquery.iframe-transport.js'%}"></script>
<script src="{% static 'js/jquery.fileupload.js'%}"></script>
<script src="{% static 'js/jquery.fileupload-process.js'%}"></script>
<script src="{% static 'js/jquery.fileupload-image.js'%}"></script>
<script src="{% static 'js/jquery.fileupload-audio.js' %}"></script>
<script src="{% static 'js/jquery.fileupload-video.js' %}"></script>
<script src="{% static 'js/jquery.fileupload-validate.js '%}"></script>
<script src="{% static 'js/jquery.fileupload-ui.js'%}"></script>
<script src="{% static 'js/main.js'%}"></script>
<script src="{% static 'js/locale.js'%}"></script>
<script src="{% static 'js/csrf.js'%}"></script>
<![endif]-->
<script>
    $(".add-video").click(function(){
        var html =  '<tr><td class="td-video"><input class="url-video form-control"></td>' +
                '<td><iframe width="100" height="75" src="" frameborder="0"></iframe></td>' +
                '<td><button type="button" class="btn cargar"><i class="glyphicon glyphicon-upload"></i>' +
                '<span>Cargar</span></button>' +
                '<button type="reset" class="btn btn-warning cancel"><i class="glyphicon glyphicon-ban-circle"></i>' +
                '<span>Cancelar</span></button></td>' +
                '<td><button type="button" class="btn btn-danger delete hidden">' +
                '<i class="glyphicon glyphicon-trash"></i><span>Borrar</span></button>' +
                '<input type="checkbox" class="toggle check-videos hidden"></td></tr>';
       $(".table-videos > tbody:last-child").append(html);
    });
    $(".table-videos").delegate("tbody>tr",'keyup', function (){
        var iframe =  $(this).find("iframe");
        var input =  $(this).find(":input");
        if (input.val() != '') {
            //$('[id$=iframeURL]').attr('style', 'position: absolute; bottom: -260px; display:block;');
            //url = $(this).val().replace('watch?v=', 'embed/') + '?rel=0';
            iframe.attr("src", input.val().replace('watch?v=', 'embed/') + '?rel=0');
        }
        else {
            frame.html('');
        }
    });
    $(".table-videos").on("click", ".cancel", function(){
         $(this).parents("tr").remove();
     });
    $(".table-videos").on("click", ".cargar", function(){
         debugger;

         var tr = $(this).parents("tr");
         var form = new FormData();

            form.append('url', tr.find(".url-video").val());
            form.append('csrfmiddlewaretoken',$('[name="csrfmiddlewaretoken"]').val());
            $.ajax({
                type:"POST",
                url:"{%url 'empresa-video-create' %}",
                data: form,
                processData: false,
                contentType: false,
                error: function(x){
                    console.log(x.responseText);
                },
                success: function(data){
                    debugger;
                    if(data != '-1'){
                         tr.data("id", data);
                    }
                    tr.find(".start").addClass("hidden");
                    tr.find(".cancel").addClass("hidden");
                    tr.find(".delete").removeClass("hidden");
                    tr.find(".check-videos").removeClass("hidden");
                },
            });
            })
    $(".table-videos").on("click", ".delete", function(){
        var tr = $(this).parents("tr");
        var form = new FormData();
        form.append('url', $(this).parents(".url-video").val());
        form.append('csrfmiddlewaretoken',$('[name="csrfmiddlewaretoken"]').val());
        $.ajax({
            type:"POST",
            url:"{%url 'empresa-video-delete' %}",
            data: form,
            processData: false,
            contentType: false,
            error: function(x){
                console.log(x.responseText);
            },
            success: function(data){
                debugger;
                if(data != '-1'){
                    tr.remove();
                }
            },
        });
    });

    function fnCargarVideos(){
        debugger;
        $.ajax({
                type:"GET",
                url:"{%url 'empresa-video-list' %}",
                //data: form,
                processData: false,
                contentType: false,
                error: function(x){
                    console.log(x.responseText);
                },
                success: function(data){

                   debugger;
                    $(data).each(function(index, el) {
                        var url_frame =
                         $(".table-videos > tbody:last-child").append('' +
                                 '<tr data-id='+"data[index].id"+'>' +
                                 '<td class="td-video"><input class="url-video form-control"></td>' +
                                 '<td><iframe width="100" height="75" src='+"data[index].url"+' frameborder="0"></iframe></td>' +
                                 '<td><button type="button" class="btn btn-danger delete">' +
                                 '<i class="glyphicon glyphicon-trash"></i><span>Borrar</span></button>' +
                                 '<input type="checkbox" class="toggle"></td></tr>');
                    });
                },
            });
    }

</script>

{% endblock %}