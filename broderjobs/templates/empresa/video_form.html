
{% load staticfiles %}

{% block content %}
<style>
.preview img {
    max-height:50px;
}
</style>
<div class="videos">
    <form id="videos" method="post" action="" enctype="" name="_video">{% csrf_token %}
        <div class="row">
            <div class="col-lg-12">
                 <button type="button" class="btn btn-success add-video">
                    <i class="glyphicon glyphicon-plus"></i>
                    <span>Agregar URL de video</span>
                </button>
                <div class="col-lg-12  content-video">
                    <table class="table table-striped table-videos ">
                        <tbody>
                            {% if videos %}
                            {% for v in videos%}
                                <tr>
                                    <td class="td-video">
                                        <input class="url-video form-control" value="{{v.url}}" data-id="{{ v.id }}">
                                    </td>
                                    <td>
                                        <iframe width="100" height="75" src="{{v.url}}" frameborder="0"></iframe>
                                    </td>
                                    <td>
                                        <button type="button" class="btn cargar hidden">
                                            <i class="glyphicon glyphicon-upload"></i>
                                            <span>Cargar</span>
                                        </button>
                                        <button type="reset" class="btn btn-warning cancel hidden">
                                            <i class="glyphicon glyphicon-ban-circle"></i>
                                            <span>Cancelar</span>
                                        </button>
                                        <button type="button" class="btn btn-danger delete">
                                            <i class="glyphicon glyphicon-trash"></i><span>Borrar</span>
                                        </button>
                                    </td>
                                </tr>
                                {%endfor%}
                            {%endif%}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
    $(function() {
        $("#form-modal .modal-title").html('Selecci√≥n de videos');
    });
    $(".add-video").click(function(){
        var html =  '<tr><td class="td-video"><input class="url-video form-control"></td>' +
                '<td><iframe width="100" height="75" src="" frameborder="0"></iframe></td>' +
                '<td><button type="button" class="btn btn-primary cargar"><i class="glyphicon glyphicon-upload"></i>' +
                '<span>Cargar</span></button>' +
                '<button type="reset" class="btn btn-warning cancel"><i class="glyphicon glyphicon-ban-circle"></i>' +
                '<span>Cancelar</span></button>' +
                '<button type="button" class="btn btn-danger delete hidden">' +
                '<i class="glyphicon glyphicon-trash"></i><span>Borrar</span></button></td></tr>';

       $(".table-videos > tbody:last-child").append(html);
    });
    $(".table-videos").delegate("tbody>tr",'keyup', function (){
        var iframe =  $(this).find("iframe");
        var input =  $(this).find(":input");
        if (input.val() != '') {
            iframe.attr("src", input.val().replace('watch?v=', 'embed/') + '?rel=0');
            input.val(iframe.attr("src"));
        }
        else {
            frame.html('');
        }
    });
    $(".table-videos").on("click", ".cancel", function(){
         $(this).parents("tr").remove();
     });
    $(".table-videos").on("click", ".cargar", function(){
         debugger;
         var input = $(this);
         var tr = $(this).parents("tr");
         var form = new FormData();

            form.append('url', tr.find(".url-video").val());
            form.append('csrfmiddlewaretoken',$('[name="csrfmiddlewaretoken"]').val());
            $.ajax({
                type:"POST",
                url:"{%url 'empresa-video-create' %}",
                data: form,
                processData: false,
                contentType: false,
                error: function(x){
                    console.log(x.responseText);
                },
                success: function(data){
                    debugger;
                    if(data != '-1'){
                         input.data("id", data);
                    }
                    tr.find(".start").addClass("hidden");
                    tr.find(".cargar").addClass("hidden");
                    tr.find(".cancel").addClass("hidden");
                    tr.find(".delete").removeClass("hidden");
                    tr.find(".check-videos").removeClass("hidden");
                },
            });
    });
    $(".table-videos").on("click", ".delete", function(){
        debugger;
        var tr = $(this).parents("tr");
        var form = new FormData();
        form.append('id', $(this).parents("tr").find("input").data("id"));
        form.append('csrfmiddlewaretoken',$('[name="csrfmiddlewaretoken"]').val());
        $.ajax({
            type:"POST",
            url:"{%url 'empresa-video-delete' %}",
            data: form,
            processData: false,
            contentType: false,
            error: function(x){
                console.log(x.responseText);
            },
            success: function(data){
                debugger;
                if(data != '-1'){
                    tr.remove();
                }
            },
        });
    });

    function fnCargarVideos(){
        $.ajax({
                type:"GET",
                url:"{%url 'empresa-video-list' %}",
                //data: form,
                processData: false,
                contentType: false,
                error: function(x){
                    console.log(x.responseText);
                },
                success: function(data){
                    $(data).each(function(index, el) {
                        var url_frame =
                         $(".table-videos > tbody:last-child").append('' +
                                 '<tr data-id='+"data[index].id"+'>' +
                                 '<td class="td-video"><input class="url-video form-control"></td>' +
                                 '<td><iframe width="100" height="75" src='+"data[index].url"+' frameborder="0"></iframe></td>' +
                                 '<td><button type="button" class="btn btn-danger delete">' +
                                 '<i class="glyphicon glyphicon-trash"></i><span>Borrar</span></button>' +
                                 '<input type="checkbox" class="toggle"></td></tr>');
                    });
                },
            });
    }
</script>

{% endblock %}