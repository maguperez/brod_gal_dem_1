{% extends 'empresa/base.html' %}
{% load staticfiles %}
{%block css%}

<link rel="stylesheet" href="https://cdn.datatables.net/s/bs/dt-1.10.10/datatables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.1.0/css/select.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.0.0/css/responsive.dataTables.min.css">

<style>
    .menu { cursor: pointer }
    .ocultar {
        display: none;
    }
</style>
{%endblock%}

{% block content %}

<section class="oportunidad-empresa">
    <div class="centered">
        <div>
            <ol class="breadcrumb">
                <li>{{oportunidad.titulo}} {{oportunidad.fase}}</li>
            </ol>
            <ol class="proceso">
                <li data-info="1" class="active">Postulaci&oacute;n</li>
                <li data-info="2">Entrevista Grupal</li>
                <li data-info="3">Entrevista Personal</li>
                <li data-info="4">Contrataci&oacute;n</li>
            </ol>
            <div class="clear"></div>
        </div>
        <div class="box header">
            <img class="imagen" src="{{empresa.set_logo}}"/>

            <div class="descripcion">
                <a href="{%url 'oportunidad' oportunidad.id%}"><h2 class="link">{{oportunidad.titulo}}</h2></a>

                <div class="empresa"><i class="empresa"></i><label>{{empresa.nombre}}</label></div>
                <div class="redes"><i class="social"></i><a><i class="facebook"></i></a><a><i class="twitter"></i></a>
                </div>
            </div>
            <div class="opciones" onclick="opciones();">
                <i class="menu"></i>
                <div class="contextual-menu" id="menu-oportunidad">
                    <div class="wrapper">
                        <div class="pin"></div>
                        <ul>
                            <li><a href="{%url 'oportunidad-editar' oportunidad.id%}"><span>Editar</span>

                                <div class="clear"></div>
                            </a></li>
                            <li><a href="{%url 'oportunidad' oportunidad.id%}"><span>Visualizar</span>

                                <div class="clear"></div>
                            </a></li>
                            <li><a href="#"><span>Archivar</span>

                                <div class="clear"></div>
                            </a></li>
                            <ul>
                    </div>
                </div>
            </div>
            <div class="estado">
                {%if oportunidad.estado_oportunidad == 'P' %}
                <label>oportunidad pendiente</label>
                {%endif%}
                {%if oportunidad.estado_oportunidad == 'A' %}
                <label>oportunidad abierta</label>
                {%endif%}
                {%if oportunidad.estado_oportunidad == 'C' %}
                <label>oportunidad cerrada</label>
                {%endif%}
                <label>CIERRA EL {{oportunidad.fecha_cese}}</label>
            </div>
            <div class="clear"></div>
        </div>
        <div class="box candidatos">
            <div class="content">
                <section>
                    <h2>Administrar Candidatos</h2>

                    <div class="estadistica">
                        <label class="cifra">{{postulaciones}}</label>
                        <label class="nombre">Inscripciones</label>
                    </div>
                    <div class="estadistica">
                        <label class="cifra">792</label>
                        <label class="nombre">Visualizaciones</label>
                    </div>
                    <div class="clear"></div>
                </section>
                <section>
                    <div class="opciones">
                        <input type="checkbox" id="marcar-todos"/><label for="marcar-todos">Marcar todos</label>
                        <a class="btn-option"><i class="delete"></i>Eliminar</a>
                        <a class="btn-option" id="siguiente-fase"><i class="next"></i>Siguiente fase</a>
                        <a class="btn-option" href="#mensaje"><i class="message"></i>Mensaje</a>
                    </div>
                    <table id="tb_candidatos" class="table table-striped table-bordered responsive" data-info="P">
                        <thead>
                        <tr>
                            <th></th>
                            <th></th>
                            <th class="align-left">Candidatos</th>
                            <th>Universidad<a></a></th>
                            <th>Carrera</th>
                            <th>Graduaci&oacute;n</th>
                            <th>Inscripci&oacute;n</th>
                            <th>Compatibilidad</th>
                            <th></th>
                            <th></th>
                        </tr>
                        </thead>

                    </table>
                </section>
            </div>
        </div>
    </div>
</section>

<div class="popup mensaje-edit" id="mensaje">
    <div class="popup-box">
        <div class="content">
            <section class="header">
                <h3>Mensaje</h3>
                <a class="btn-action" onclick="window.history.back();">ENVIAR</a>

                <div class="clear"></div>
            </section>
            <section>
                <div class="destinatarios">
                    <label>Para:</label>
                    <ul>
                        <li>
                            <img class="imagen" src="../img/profile/profile.png"/>
                            <label class="nombre">Diego Ch&aacute;vez</label>
                        </li>
                    </ul>
                    <div class="clear"></div>
                </div>
                <textarea placeholder="Redacte su mensaje"></textarea>

                <div class="sin-respuesta">
                    <input type="checkbox" id="sin-respuesta"/>
                    <label for="sin-respuesta">Sin respuesta </label><a>(<span class="orange">?</span>)</a>
                </div>
            </section>
        </div>
        <a class="close">Cerrar</a>
    </div>
</div>

<div id="form-modal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h2 class="modal-title bold">Modal title</h2>
			</div>
            <div id="form-modal-body" class="modal-body">
				<p>One fine body&hellip;</p>
			</div>
            <!--<div class="modal-footer">-->
				<!--<input type="submit" class="btn btn-primary btn-submit" value ="Guardar" id="modal-aceptar">-->
				<!--<button type="button" class="btn btn-default" data-dismiss="modal" id="modal-cerrar">Cerrar</button>-->
			<!--</div>-->
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<input type="hidden" id="fase" value="{{oportunidad.fase.id}}">
<input type="hidden" id="fase-activa" value="{{oportunidad.fase.id}}">
<input type="hidden" id="f-postulados" value="1">
<input type="hidden" id="f-grupal" value="2">
<input type="hidden" id="f-personal" value="3">
<input type="hidden" id="f-contratacion" value="4">
{% endblock %}

{% block js %}
<script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/select/1.1.0/js/dataTables.select.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.0.0/js/dataTables.responsive.min.js"></script>

<script>
    var iniciado = false;
    var selected;
    var JSCandidatos = function () {
            this.inicializar = function(){
                $("#tb_candidatos").on("click", ".cargar-cv", function () {
                    id = $(this).parent().data("id");
     	            $('#form-modal-body').load('cv/'+id, function () {
        	            $('#form-modal').modal('toggle');
                        formAjaxSubmit('#form-modal-body form', '#form-modal');
		            });
                });
            };
            this.obtener = function(){
               return $('#tb_candidatos').dataTable({
                    responsive: {
                        details: {
                            type: 'control',
                            target: 8
                        }
                    },
                    destroy: true,
                    searching: false,
                    language: {
                        url: "{%static 'js/dataTable-i18n/es-ES.json' %}"
                    },
                    columnDefs: [
                        {sortable: false, targets: [0, 8, 9]},
                        {searchable: false, targets: [0, 8, 9]},
                        {class: "all", targets: [0, 2, 4, 5, 6, 7, 8]},
                        {class: "none", targets: [9]},
                        {class: "never", targets: [1]},
                        {
                            targets: 0,
                            className: 'dt-body-center',
                            render: function (data, type, full, meta) {
                                return '<input class = "checking" type="checkbox"' + "data-info='"+ full.id +"'"+
                                        (selected != null && selected[full.id] != null ? "checked" : "") + '>';
                            }
                        },
                        {
                            targets: 8,
                            className: 'dt-expandir',
                            render: function (data, type, full, meta) {
                                return '<i class="menu"></i>';
                            }
                        },
                        {
                            targets: 9,

                            render: function (data, type, full, meta) {
                                return '<div class="" data-id="' + full["id"] + '">' +
                                        '<a class="btn-option"><i class="delete"></i>Eliminar</a>' +
                                        '<a class="btn-option"><i class="next"></i>Siguiente fase</a>' +
                                        '<a class="btn-option" href="#mensaje"><i class="message"></i>Mensaje</a>' +
                                        '<a class="btn-option cargar-cv"><i class="curriculum"></i>Ver CV</a>' +
                                        '</div>';
                            }
                        },
                    ],
                    filter: false,
                    serverSide: true,
                    processing: true,
                    lengthChange: false,
                    stateSave: true,
                    stateSaveCallback: function (settings, data) {
//                debugger;
                    },
//                    ajax: {
//                        type: "GET",
//                        url: "{% url 'candidatos' %}",
//                        data: function (d) {
//                            d.id = "{{oportunidad.id}}";
//                        },
//                        success:
//                            function (msg) {
//                                //var json = $.parseJSON(msg);
//                                fnCallback(msg);
//                                $(".tEvaluacion").show();
//                            }
//                    },
                     ajax: {
                        type: "GET",
                        url: "{% url 'candidatos' %}",
                        data: function (d) {
                            d.id = "{{oportunidad.id}}";
                            d.f = $("#fase").val();
                        }
                    },
                    columns: [
                        {data: "checkbox", class:"check-row"},
                        {data: "id"},
                        {data: "nombre"},
                        {data: "universidad"},
                        {data: "carrera"},
                        {data: "graduacion"},
                        {data: "fecha_postulacion"},
                        {data: "compatibilidad"},
                        {data: "botones"},
                        {data: "botones"},
                    ],
                });
            }
        }
    var CandidatosTable = new JSCandidatos();
    var formAjaxSubmit = function(form, modal) {
	    $(form).submit(function (e) {
		    e.preventDefault();
            $.ajax({
			    type: $(this).attr('method'),
				url: $(this).attr('action'),
				data: $(this).serialize(),
				    success: function (xhr, ajaxOptions, thrownError) {
					    if ($(xhr).find('.has-error').length > 0) {
						    $(modal).find('.modal-body').html(xhr);
							 formAjaxSubmit(form, modal);
                        } else {
						    $(modal).modal('toggle');
                             window.location.reload();
						 }
					},
                    error: function (xhr, ajaxOptions, thrownError) { }
                });
            });
	    }

    $(document).ready(function () {
      var table = CandidatosTable.obtener();
       if (!iniciado) {
           iniciado = true;
           CandidatosTable.inicializar();
       }
       $("#tb_candidatos").on("change",".checking", function() {
           selected = new Array();
           var data = table.api().row($(this).parents('tr')).data();
           if ($(this).is(":checked"))
               selected[data.id] = data;
               else if (selected[data.id] != null) selected[data.id] = null;
       });
        $('#siguiente-fase').click(function (event) {
            ids = new Array();
            $("input:checked", table.fnGetNodes()).each(function(index, value){
                ids[index] = $(this).data("info");
            });
            $("#fase").val( parseInt($("#fase").val()) + 1);
            CambioFase(ids);

        });

        $("#proceso li").each(function()){


        }

   });

    function CambioFase(ids){
        //var json = JSON2.stringify(ids );
        $.ajax({
           // data: {'ids': ids},
            url: '{%url "siguiente-fase" %}',
            type: 'GET',
            data: {'ids': JSON.stringify(ids), 'f': $("#fase").val(), 'o': '{{oportunidad.id}}'},
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                CandidatosTable.obtener();
            }
        });
    }







</script>
{%endblock%}