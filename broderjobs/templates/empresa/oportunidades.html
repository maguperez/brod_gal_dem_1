{% load staticfiles %}

{% if oportunidades|length %}
		{% for oportunidad in oportunidades.all%}

					<li class="oportunidad-estadistica">
						<div class="box header">
							<img class="imagen" src="{{empresa.set_logo}}" />
							<div class="descripcion">
								<a href="{%url 'empresa-oportunidad-candidatos' oportunidad.id%}"><h2 class="link">{{oportunidad.titulo}}</h2></a>
								<div class="empresa"><i class="empresa"></i><label class = "text-uppercase">{{empresa.nombre}}</label></div>
							</div>
							<div class="opciones" onclick="opciones({{oportunidad.id}})">
								<i class="menu"></i>
								<div class="contextual-menu" id="menu-{{oportunidad.id}}">
									<div class="wrapper">
										<div class="pin"></div>
										<ul>
											<li><a href="{%url 'oportunidad-editar' oportunidad.id%}"><span>Editar</span><div class="clear"></div></a></li>
											<li><a href="candidatos_oportunidad.html"><span>Ver candidatos</span><div class="clear"></div></a></li>
											<li><a href="{%url 'oportunidad-archivar' oportunidad.id%}"><span>Archivar</span><div class="clear"></div></a></li>
										<ul>
									</div>
								</div>
							</div>
							<div class="estado">
								{%if oportunidad.estado_oportunidad == 'P' %}
									<label>pendiente</label>
								{%endif%}
								{%if oportunidad.estado_oportunidad == 'A' %}
									<label>abierta</label>
								{%endif%}
								{%if oportunidad.estado_oportunidad == 'C' %}
									<label>cerrada</label>
								{%endif%}
								<label>CIERRA EL {{oportunidad.fecha_cese}}</label>
							</div>
							<div class="clear"></div>
						</div>
						<div class="visualizaciones">
							<div class="box">
								<div class="estadistica">
									<div class="cifra">
										<label>792</label>
										<label>Visualizaciones</label>
									</div>
									<div class="grafico grafico-barras">
										<span class = "sparklines" data-id = "{{oportunidad.id}}"/>
									</div>
									<div class="clear"></div>
								</div>
								<div class="estadistica">
									<div class="cifra" >
										<label id="cifra-{{oportunidad.id}}"></label>
										<label>Inscripciones</label>
									</div>
									<div class="grafico usuarios fotos-post" id="foto-post-{{oportunidad.id}}">
										<div class="clear"></div>
									</div>
									<div class="clear"></div>
								</div>
							</div>
						</div>
						<div class="inscripciones">
							<div class="box">
								<label class="titulo"><strong>Inscripciones en los &uacute;ltimos 7 d&iacute;as</strong></label>
								<div class="grafico grafico-inscripciones">
									<div id = "chart-id-{{oportunidad.id}}" data-id="{{oportunidad.id}}" class="ct-chart " data-info = "[[5, 9, 7, 8, 5, 3, 5, 4]]"></div>
									{{postulaciones}}
								</div>
							</div>
						</div>
						<div class="clear"></div>
					</li>
    {% endfor %}
    {%else%}
    <li><label> No hay Oportunidades que mostrar...</label>
    </li>
{% endif %}


<script src="{% static 'js/jquery.sparkline.min.js' %}"></script>
<script src="{% static 'js/chartist.min.js' %}"></script>
<script src="{% static 'js/mixpanel_data_export.js' %}"></script>
<script src="{% static 'js/moment.js' %}"></script>
<script src="{% static 'js/moment-with-locales.js' %}"></script>
<link rel = "stylesheet" href="{% static 'css/chartist.min.css' %}"/>
<script>
	moment.locale('es');
	panel = new MixpanelExport({
		api_key: "b374f1f8bfadcf8c42f2e06c3db07a88",
		api_secret: "be1d1645e65e9a294c102cdb8dbbf209"
	});

	$(function() {

		var date = moment().format("YYYY-MM-DD");
		var last = moment().subtract(7, 'days').format("YYYY-MM-DD");

		$(".sparklines").each(function () {
			var id = $(this).data("id");
			var data = $(this).data("info");
			var obj = $(this)
			panel.retention({
				from_date: last,
				to_date: date,
				expire: 8798798765,
				retention_type: "compounded",
				event: "Visita Oportunidad",
				//born_event: "Visita Oportunidad",
				where: 'properties["OportunidadID"] == "'+ id +'"'
			}).then(function(data) {
				var array = new Array();
				for (var i = 6; i >= 0 ; i--) {
					debugger;
					var last = moment().subtract(i, 'days');
					array.push(data[last.format("YYYY-MM-DD")] == null ? 0 : data[last.format("YYYY-MM-DD")].first);
				}
				$(obj).sparkline(array, {
					type: 'bar',
					height: '50px',
					barSpacing: 7,
					barWidth: 10,
					barColor: '#5d9cf9'
				});
			});
		});
		var array = new Array();
		for (var i = 6; i >= 0 ; i--) {
			var last = moment().subtract(i, 'days');
			array.push(last.format('dddd'));
		}
		$(".ct-chart").each(function(){
			var id = $(this).data("id");
			var d = [];
			$.ajax({
				data: {'id': id},
				url: '{%url "empresa-oportunidad-postulaciones" %}',
				type: 'get',
				success: function (data) {
					$("#cifra-"+id).html(data[0][0]);
					new Chartist.Line("#chart-id-"+id, {
						labels: array,
						colors:["#333", "#222", "#111", "#000"],
						series: [data[0][1]]
					}, {
						low: 0,
						showArea: true
					});
				}
			});
		});
		$(".fotos-post").each(function(){
			var ele = $(this).attr("id").split("-");
			var id = ele[2];
			$.ajax({
				data: {'id': id},
				url: '{%url "empresa-oportunidad-estudiantes" %}',
				type: 'get',
				success: function (data) {
					var html = "";
					for(var i = 0; i <data.length ; i++) {
						html += '<img src="'+ data[i] + '"/>';
					}
					$("#foto-post-"+id).html(html);
				}
			});
		});
	})
</script>
<style>
	.ct-chart { margin-left: -40px; margin-top: -20px;}
</style>