<style>

	#id_pais{
		width: 155px !important;
	}

	#id_ciudad{
		width: 175px !important;
	}

	.select2-selection--single{
		background-color: #f9f9f9 !important;
		border-color: #ccc !important;
	}
    .tooltip {
        z-index: 5000;
    }
</style>
<div style="margin:0 50px">
	<form id = "form-info-personal" action="{% url 'mi-cv-info-personal' %}" method="post" autocomplete="off">
		{%csrf_token%}
		<div class="form-horizontal">
			<h3><i class="academic"></i> &nbsp;Información académica</h3><br>
			<div class ="form-group">
				<label class = "col-sm-3">Grado estudio</label>
				<div class = "col-sm-9">
					{{form.grado_estudio}}
				</div>
			</div>
			<div class ="form-group">
				<label class = "col-sm-3">Universidad</label>
				<div class = "col-sm-9">
					{{form.universidades}}
					{{form.universidades_hidden}}
				</div>
			</div>
			<div class ="form-group">
				<label class = "col-sm-3">Carrera</label>
				<div class = "col-sm-9">
					{{form.carreras}}
					{{form.carreras_hidden}}
				</div>
			</div>
			<div class ="form-group">
				<label class = "col-sm-3">Inicio de estudios</label>
				<div class = "col-sm-4">
					{{form.semestre_inicio_estudio}}
				</div>
				<div class = "col-sm-4">
					{{form.ano_inicio_estudio}}
				</div>
			</div>
			<div class ="form-group">
				<label class = "col-sm-3">Graduación / Grad. estimada</label>
				<div class = "col-sm-4">
					{{form.semestre_graduacion}}
				</div>
				<div class = "col-sm-4">
					{{form.ano_graduacion}}
				</div>
			</div>
            <div class ="form-group {%if form.grado_estudio.value != 1%} hidden {% endif %}"   id ="ciclo-actual">
				<label class = "col-sm-3">Ciclo Actual</label>
				<div class = "col-sm-4">
					{{form.semestre_actual}}
				</div>
			</div><br>
			<h3><i class="info"></i> &nbsp;Información personal</h3><br>
			<div class ="form-group">
				<label class = "col-sm-3">Contacto</label>
				<div class = "col-sm-4">
					{{form.email}}
				</div>
				<div class = "col-sm-4">
					{{form.telefono}}
				</div>
			</div>
			<div class ="form-group">
				<label class = "col-sm-3">Ubicacion actual</label>
				<div class = "col-sm-4">
					{{form.pais}}
				</div>
				<div class = "col-sm-4">
					<select class="full" id="id_ciudad" name="ciudad"></select>
					{{form.ciudad_hidden}}
				</div>
			</div>
			<div class ="form-group">
				<label class = "col-sm-3">Fecha de nacimiento</label>
				<div class = "col-sm-8">
					{{form.fecha_nacimiento}}
				</div>
			</div>
			<div class ="form-group">
				<label class = "col-sm-3">Género</label>
				<div class = "col-sm-8">
					<p>
						{% for genero in form.genero %}
							 {{ genero }}
						{% endfor %}
					</p>
				</div>
			</div>
            <div class ="form-group">
				<label class = "col-sm-3">Remuneracion deseada</label>
				<div class = "col-sm-4">
					{{form.remuneracion_min}}
				</div>
				<div class = "col-sm-4">
					{{form.remuneracion_max}}
				</div>
			</div>
		</div>
	</form>
</div>
<script>

	var flagSeleccionarUniversidad = true;
	var flagSeleccionarCarrera = true

	$(function(){
		$("form input, form select, form textarea").addClass("form-control");
		$(".modal-title").html('&nbsp;Información');
		$("#id_fecha_nacimiento").datepicker({
			autoclose: true,
			language: 'es',
			format: "dd/mm/yyyy",
			endDate:"0d"
		})

		InicializarTypeaheadElementos();

		$.validator.addMethod('universidadExistente',function(value, element, param){
			return flagSeleccionarUniversidad;
		},'Debe seleccionar una universidad existente');

		$.validator.addMethod('carreraExistente',function(value, element, param){
			return flagSeleccionarCarrera;
		},'Debe seleccionar una carrera existente');

		$.validator.addMethod('validarCiclos',function(value, element, param){
			return (parseInt($("#id_ano_graduacion").val() + $("#id_semestre_graduacion").val()) >= parseInt($("#id_ano_inicio_estudio").val() +$("#id_semestre_inicio_estudio").val()));
		},'El ciclo de ingreso debe ser menor que la graduacion estimada');


		$('#id_universidades').change(function(){
			var strInput = $('#id_universidades').val();
			var objSeleccionado = $('#id_universidades').typeahead('getActive');

			if(objSeleccionado){
				if(objSeleccionado.name != strInput){
					flagSeleccionarUniversidad = false;
				}
				else{
					flagSeleccionarUniversidad = true;
					var validator = $("#form-info-personal").validate();
					validator.element( "#id_universidades" );
				}
			}
			else if(strInput.length > 0){
				flagSeleccionarUniversidad = false;
			}
		});

		$('#id_carreras').change(function(){
			var strInput = $('#id_carreras').val();
			var objSeleccionado = $('#id_carreras').typeahead('getActive');

			if(objSeleccionado){
				if(objSeleccionado.name != strInput){
					flagSeleccionarCarrera = false;
				}
				else{
					flagSeleccionarCarrera = true;
					var validator = $("#form-info-personal").validate();
					validator.element( "#id_carreras" );
				}
			}
			else if(strInput.length > 0){
				flagSeleccionarCarrera = false;
			}
		});

		$("#id_pais").select2({
  			placeholder: "Pais",
  			//allowClear: true
		});
		$("#id_ciudad").select2({
  			placeholder: "Ciudad",
  			//allowClear: true
		});

		$("#id_pais").change(function() {
			if($("#id_pais").val() > 0 ){
				$.ajax({
					data: {'pais': $("#id_pais").val()},
					url: '{%url "ciudad-busqueda" %}',
					type: 'get',
					success: function (data) {
						if (data) {
							if (data.length > 0) {
//								var options = '<option value="">Ciudad</option>';
								var options = '';
								for (var i = 0; i < data.length; i++) {
									options += '<option value="' + data[i].pk + '">' + data[i].fields['descripcion'] + '</option>';
								}
								$("#id_ciudad").html(options);
								// $("#id_ciudad option:first").attr('selected', 'selected');
								$("#id_ciudad").select2("val", "");
								$("#id_ciudad").attr('disabled', false);
							}
						}
					}
				});
			}
			else{
				var options = '';
				$("#id_ciudad").html(options);
				$("#id_ciudad").select2("val", "");
				$("#id_ciudad").attr('disabled', false);
			}
		});
		$("#id_ciudad").change(function() {
			$('#id_ciudad_hidden').val($(this).val());
		});

		IniciarCiudades();
		InicializarValidaciones();

		$("#id_ano_inicio_estudio, #id_ano_graduacion, "+
            "#id_semestre_inicio_estudio, #id_semestre_graduacion").change(function() {
            if ($(this).val() != "")
			LlamarValidacionCiclos($(this).attr("id"));
		});
        $("#id_grado_estudio").change(function(){
            if($("#id_grado_estudio").val()== 1){
                $("#ciclo-actual").removeClass("hidden");
            }else{
                $("#ciclo-actual").addClass("hidden");
                $("#id_semestre_actual").val("");
            }

        });
	});

	function IniciarCiudades() {
		$.ajax({
			data: {'pais': $("#id_pais").val()},
			url: '{%url "ciudad-busqueda" %}',
			type: 'get',
			success: function (data) {
				if (data) {
					if (data.length > 0) {
						var options = '';
						for (var i = 0; i < data.length; i++) {
							options += '<option value="' + data[i].pk + '">' + data[i].fields['descripcion'] + '</option>';
						}
						$("#id_ciudad").html(options);
						$("#id_ciudad").val($("#id_ciudad_hidden").val()).trigger("change");
						$("#id_ciudad").attr('disabled', false);
					}
				}
			}
		});
	}

	function LlamarValidacionCiclos(id){
		if (id != "id_ano_inicio_estudio") LlamarValidacionElemento('id_ano_inicio_estudio');
		if (id != "id_ano_graduacion") LlamarValidacionElemento('id_ano_graduacion');
		if (id != "id_semestre_inicio_estudio") LlamarValidacionElemento('id_semestre_inicio_estudio');
		if (id != "id_semestre_graduacion") LlamarValidacionElemento('id_semestre_graduacion');
	}

	function LlamarValidacionElemento(id){
		$('#'+id).valid();
	}

	function InicializarValidaciones(){
		$("#form-info-personal").validate({
            errorPlacement: function (error, element) {
                var object, placement;
                if(element[0].id == 'id_ano_inicio_estudio' || element[0].id == 'id_ano_graduacion' ){
                    debugger;
					object = $(element);
					placement = "right";

				} else if(error[0].innerText == "El ciclo de ingreso debe ser menor que la graduacion estimada"){
                    debugger;
					if (element[0].id == 'id_ano_inicio_estudio' || element[0].id == 'id_ano_graduacion'){
						object = $(element);
						placement = "right";
					}
                    else {
                        $(element).tooltip('hide');
                    }
				}
				else if(element[0].id == 'id_telefono'){
                    object = $(element);
                    placement: "right";
				}
				else if(element[0].id == 'id_genero_0'){
					object = $('#id_genero_1');
                    placement = "right";
				}
                else{
					object = $(element);
					placement = "left";
				}
                debugger;
                $(object).tooltip('destroy');
                $(object).tooltip({
					animation: true,
					container: 'body',
					placement: placement,
					title: $(error).text(),
					trigger: "manual"
				});
                $(object).tooltip('show');

            },
            success: function (label, element) {
				if(element.id == 'id_genero_0'){
					$('#id_genero_1').tooltip('hide');
				}
				else{
					$(element).tooltip('hide');
				}

            },
            rules: {
				grado_estudio: {
                    required: true
                },
				universidades: {
                    required: true,
					universidadExistente: true
                },
				carreras: {
                    required: true,
					carreraExistente: true
                },
				semestre_inicio_estudio:{
                    required: true,
					validarCiclos: true
                },
				ano_inicio_estudio:{
                    required: true,
					validarCiclos: true
                },
				semestre_graduacion:{
                    required: true,
					validarCiclos: true
                },
				ano_graduacion:{
                    required: true,
					validarCiclos: true
                },
				email: {
                    required: true,
                    email: true
                },
				telefono: {
                    digits: true
                },
				pais:{
                    required: true
                },
				ciudad:{
                    required: true
                },
				fecha_nacimiento:{
					required: true
				},
				genero:{
					required: true
				}
            },
            messages: {
				grado_estudio: {
                    required: "Este campo es obligatorio"
                },
				universidades: {
                    required: "Este campo es obligatorio"
                },
				carreras: {
                    required: "Este campo es obligatorio"
                },
				semestre_inicio_estudio:{
                    required: "Este campo es obligatorio"
                },
				ano_inicio_estudio:{
                    required: "Este campo es obligatorio"
                },
				semestre_graduacion:{
                    required: "Este campo es obligatorio"
                },
				ano_graduacion:{
                    required: "Este campo es obligatorio"
                },
				email: {
                    required: "Este campo es obligatorio",
                    email: "Introduzca un correo válido"
                },
				telefono: {
                    digits: "Este campo solo contiene digitos"
                },
				pais:{
                    required: "Este campo es obligatorio"
                },
				ciudad:{
                    required: "Este campo es obligatorio"
                },
				fecha_nacimiento:{
					required: "Este campo es obligatorio"
				},
				genero:{
					required: "Este campo es obligatorio"
				}
            }
        });
	}

	function InicializarTypeahead(idElemento, idHidden, ruta){
		$("#"+idElemento).typeahead({
			source: function(buscar,cargarResultado){
				console.log(buscar);
				$.ajax({
					data : {'busqueda': buscar},
					url: ruta,
					type: 'get',
					success: function(data){

						if(data){
							if(data.length > 0) {
								var arreglo = [];
								data.forEach(function(obj){
									var obje = {};
									obje.id = obj.pk;
									obje.name = obj.fields.descripcion;

									arreglo.push(obje);
								});

								cargarResultado(arreglo);
							}
						}
					}

				});
			},
			minLength: 3
		});

		$("#"+idElemento).change(function() {
			var current = $("#"+idElemento).typeahead("getActive");
			if (current) {
				// Some item from your model is active!
				if (current.name == $("#"+idElemento).val()) {
					$("#"+idHidden).val(current.id);
				} else {
					// This means it is only a partial match, you can either add a new item
					// or take the active if you don't want new items
				}
			} else {
				// Nothing is active so it is a new value (or maybe empty value)
			}
		});
	}

	function InicializarTypeaheadElementos(){

//		InicializarTypeahead('id_paises', 'id_paises_hidden', '{%url "pais-busqueda" %}');
		InicializarTypeahead('id_universidades', 'id_universidades_hidden', '{%url "universidad-busqueda" %}');
		InicializarTypeahead('id_carreras', 'id_carreras_hidden', '{%url "carrera-busqueda" %}');

//		$("#id_ciudades").typeahead({
//			source: function(buscar,cargarResultado){
//				var valor = document.getElementById('id_paises_hidden').value;
//				$.ajax({
//					data : {'busqueda': buscar,'pais': valor},
//					url: '{%url "ciudad-busqueda" %}',
//					type: 'get',
//					success: function(data){
//
//						if(data){
//							if(data.length > 0) {
//								var arreglo = [];
//								data.forEach(function(obj){
//									var obje = {};
//									obje.id = obj.pk;
//									obje.name = obj.fields.descripcion;
//
//									arreglo.push(obje);
//								});
//
//								cargarResultado(arreglo);
//							}
//						}
//					}
//
//				});
//			}
//		});
//
//		$("#id_ciudades").change(function() {
//			var current = $("#id_ciudades").typeahead("getActive");
//			if (current) {
//				// Some item from your model is active!
//				if (current.name == $("#id_ciudades").val()) {
//					$('#id_ciudades_hidden').val(current.id);
//				} else {
//					// This means it is only a partial match, you can either add a new item
//					// or take the active if you don't want new items
//				}
//			} else {
//				// Nothing is active so it is a new value (or maybe empty value)
//			}
//		});

	}



</script>