{% extends 'estudiante/base.html' %}
{% load estudiante_filters %}
{% load staticfiles %}
{%block css%}
<style>
	.noleido{
		background: #ECECEC !important;
		font-weight: bold !important;
	}
	.leido{
		background: #fff !important;
		font-weight: normal !important;
	}
</style>
{%endblock%}
{% block content %}
<section class="proceso-detalle" style="padding-top: 150px">
			<div class="centered">
				<div class="box">
					<div class="content">
						<section class="oportunidad-resumen">
							<img class="imagen" src="{{empresa.set_logo}}" alt="{{empresa.nombre}}" />
							<div class="detalle">
								<h1>{{oportunidad.titulo}}</h1>
								<a href="{%url 'estudiante_empresa_detalle' empresa.id%}"><h4 class="link">{{empresa.nombre |upper}}</h4></a>
								<label>{{oportunidad.ciudad}}, {{oportunidad.pais}}</label>
								<label>Remuneraci&oacute;n: {{oportunidad.remuneracion}} </label>
							</div>
							<div class="estado">
								<label>Estado del proceso:</label>
								<label>
									{%if postulacion.estado_postulacion == 'P'%}
									Postulado
									{%endif%}
									{%if postulacion.estado_postulacion == 'E'%}
									En Evaluacion
									{%endif%}
									{%if postulacion.estado_postulacion == 'F'%}
									Finalizado
									{%endif%}
								</label>
							</div>
							<div class="clear"></div>
						</section>
						<section class="contenido">
							<div class="menu">
								<a class="active" id="menu-estado">Estado</a>
								<a id="menu-mensajes">Mensajes</a>
							</div>
							<div class="detail">

								<div class="estado active" id="content-estado">
									<div id = "wizard" class = "grafico">
										<div class="wizard-progress wizard-progress-lg">
											<div class="steps-progress">
												<div class="progress-indicator" style="width: 0%;"></div>
											</div>
											<ul class="wizard-steps">
												<li class = "{%if postulacion.estado_postulacion == 'P' %}active on{%endif%}">
													<a href="#tab1" data-toggle="tab"><span class = "fa fa-check"></span>Postulacion</a>
												</li>
												<li class ="{%if postulacion.estado_postulacion == 'E'%}active on{%endif%}">
													<a href="#tab2" data-toggle="tab"><span class = "fa fa-check"></span>Evaluacion</a>
												</li>
												<li class ="{%if postulacion.estado_postulacion == 'F'%}active on{%endif%}">
													<a href="#tab3" data-toggle="tab"><span class = "fa fa-check"></span>Finalizado</a>
												</li>
											</ul>
										</div>
									</div>

										<div class="clear"></div>
									<p>Tu postulaci&oacute;n ha sido registrada satisfactoriamente y te encuentras en la etapa de
										{%if postulacion.estado_postulacion == 'P'%}
											Postulado,
											{%endif%}
											{%if postulacion.estado_postulacion == 'E'%}
											En Evaluacion,
											{%endif%}
											{%if postulacion.estado_postulacion == 'F'%}
											Finalizado,
											{%endif%} te notificaremos cuando el proceso haya finalizado.</p>
								</div>
								<div class="mensajes" id="content-mensajes">
									<table class = "bj-table">
										<tbody>
											<tr class="unread">
												<th>Empresa</th>
												<th>Asunto</th>
												<th>Fecha</th>
											</tr>
                                            {%for m in mensajes.all%}
											<tr  class="unread" data-id="{{m.id}}" >
												<td class="{%if m.leido%}leido{%else%}noleido{%endif%}">
													{{m.mensaje.oportunidad.empresa}}</td>
												<td class="{%if m.leido%}leido{%else%}noleido{%endif%}">
													{{m.mensaje.asunto}}!</td>
												<td class="{%if m.leido%} leido{%else%}noleido{%endif%}">
												{{m.fecha_creacion}}</td>
											</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							<div class="clear"></div>
								</div>
						</section>
					</div>
				</div>
			</div>
		</section>
		<div class="popup mensaje" id="popup-mensaje">
			<div class="popup-box">
				<div class="content" id="contenido-mensaje">
					<section class="header">
						<h4 class="link" id="mensaje-empresa"></h4>
						<label class="info" id="mensaje-fecha-recibido"></label>
					</section>
					<section class="mensaje">
						<label class="asunto" id="mensaje-asunto"></label>
						<p id="mensaje-contenido"></p>
						<a href="#mensaje-edit" class="btn-action" id="responder-mensaje">RESPONDER</a>
					</section>
				</div>
				<a class="close">Cerrar</a>
			</div>
		</div>
		<div class="popup mensaje-edit" id="mensaje-edit">
    		<div class="popup-box">
        		<div class="content">
            <section class="header">
                <h3>Mensaje</h3>
                <a id="enviar-mensaje" class="btn-action">ENVIAR</a>
                <div class="clear"></div>
            </section>
            <section>
                <div class="destinatarios">
                    <label>Para:</label>
                    <ul><li></li></ul>
                    <div class="clear"></div>
                </div>
                <textarea id="contenido-mensaje-enviar" placeholder="Redacte su mensaje"></textarea>
                <!--<div class="sin-respuesta">-->
                    <!--<input type="checkbox" id="sin-respuesta"/>-->
                    <!--<label for="sin-respuesta">Sin respuesta </label><a>(<span class="orange">?</span>)</a>-->
                <!--</div>-->
            </section>
        </div>
        		<a class="close">Cerrar</a>
    		</div>
		</div>
<input type="hidden" id="empresa_id">
<input type="hidden" id="mensaje_destinatario_id">
<input type="hidden" id="usuario_id">
{%csrf_token%}
{% endblock content%}
{% block js %}
<script type="text/javascript" src="{% static 'js/jquery.bootstrap.wizard.js' %}"></script>
<script>
	$(".loading-wrapper").hide();
	$("#link-procesos").addClass("active");
	$('.popup').click(function(e) {
		if ( $(e.target).closest('.popup-box').length === 0 ) {
			window.history.back();
			$('body').removeClass('static');
		}
	});
	$('.popup .close').click(function(e) {
		window.history.back();
		$('body').removeClass('static');
	});
	$('#menu-estado').click(function() {
		$('.contenido .detail > div').removeClass('active');
		$('.contenido .menu a').removeClass('active');
		$('#content-estado').addClass('active');
		$('#menu-estado').addClass('active');
	});
	$('#menu-mensajes').click(function() {
		$('.contenido .detail > div').removeClass('active');
		$('.contenido .menu a').removeClass('active');
		$('#content-mensajes').addClass('active');
		$('#menu-mensajes').addClass('active');
	});
	$('#content-mensajes tr').click(function() {
		fnMostrarMensaje($(this).data("id"));
		window.location = '#popup-mensaje';
		$(this).children("td").removeClass('noleido');
		$(this).children("td").addClass('leido');
	});
	$('a').click(function(event) {
		var id = event.target.href.substr(event.target.href.lastIndexOf('#'))
        if ($(id).hasClass('popup'))
			$('body').addClass('static');
    });
	window.onload = function(){
	$('.wizard-progress').bootstrapWizard({
		tabClass: 'wizard-steps',
		onTabClick: function( tab, navigation, index, newindex ) {
			//debugger;
		},
		onTabChange: function( tab, navigation, index, newindex ) {
			//debugger;
			//var $total = navigation.find('li').size() - 1;
			//$wizardfinish[ newindex != $total ? 'addClass' : 'removeClass' ]( 'hidden' );
			//$('#wizard').find(this.nextSelector)[ newindex == $total ? 'addClass' : 'removeClass' ]( 'hidden' );
		},
		onTabShow: function( tab, navigation, index ) {
			//debugger;
			$(".wizard-progress li").removeClass("active");
			$(".wizard-progress li.on").addClass("active");
			if (tab.is(":not(.on")){
				return false;
			}
			var $total = navigation.find('li').length - 1;
			var $current = index;
			var $percent = Math.floor(( $current / $total ) * 100);
			$('#wizard').find('.progress-indicator').css({ 'width': $percent + '%' });
			tab.prevAll().addClass('completed');
			tab.nextAll().removeClass('completed');
			return false;
		}
		}, 5000);
	};

	function fnMostrarMensaje(id){
        $.ajax({
            url: "{%url 'mensaje-ver' %}",
            type: 'GET',
            data: {'id': id },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
				$("#mensaje-empresa").html(data["empresa"]);
				$("#mensaje-fecha-recibido").html(data["fecha_creacion"]);
				$("#mensaje-asunto").html(data["asunto"]);
            	$("#mensaje-contenido").html(data["contenido"]);
				$("#empresa_id").val(data['empresa_id']);
				$("#mensaje_destinatario_id").val(data['mensaje_destinatario_id']);
				$("#usuario_id").val(data['usuario_id']);
				if(data['permite_respuesta'] == "True")
				{
					$("#responder-mensaje").show();
				}
				else{
					$("#responder-mensaje").hide();
				}
			}
        });
    }
	$('#responder-mensaje').click(function(e){
		$('.destinatarios ul li').html($("#mensaje-empresa").html());
	});

	 $('#enviar-mensaje').click(function(){
		 id = $("#empresa_id").val();
		 var form = new FormData();
		 form.append('id',$("#empresa_id").val());
		 form.append('c',$('#contenido-mensaje-enviar').val());
		 form.append('id_o','{{postulacion.oportunidad.id}}');
		 form.append('id_p','{{postulacion.id}}');
		 form.append('id_md', $('#mensaje_destinatario_id').val());
		 form.append('id_u', $('#usuario_id').val());
		 form.append('pr','S');
		 form.append('csrfmiddlewaretoken',$('[name="csrfmiddlewaretoken"]').val());
		     $.ajax({
                 type:"POST",
                 url:"{%url 'mensaje-enviar' %}",
                 data: form,
                 processData: false,
                 contentType: false,
                 success: function(x){
                     window.history.back();
					 window.history.back();
                 },
                 error: function(x){
                    console.log(x.responseText);
                 }
            });
       });

</script>
{% endblock%}