{%load staticfiles %}

<!--&lt;!&ndash;<script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>&ndash;&gt;-->
<script type="text/javascript" src="{% static 'js/jquery.bootstrap.wizard.js' %}"></script>
 <section class = "">
     <div class="row introduccion">
                         <div class="col-sm-12"><h3>Test</h3></div>
                         <div class="col-sm-12">Instrucciones: </div>
                         <div class="col-sm-12">
                         <p>Se presentan una serie de preguntas, para cada una debes elegir cual es la que MÁS te describe,
                             y cual te describe MENOS.
                         </p>
                             <ul>
                                 <li> - Debes completar el test de lo contrario las respuestas no se almacenaran,
                                        si no puedes terminarlo ahora selecciona <b>En otro momento</b> para realizarlo nuevamente</li>
                                 <li> - Porfavor se se cuidadoso, una vez seleccionada las opciones no podrás regresar de pregunta</li>
                                 <li> - No hay limite de tiempo, puedes hacerlo con calma, tratar de ser lo más sincero posible</li>
                             </ul>
                         </div>
                     </div>
     <div id = "wizard">
         <div class="wizard-progress wizard-progress-lg">
             <ul class="wizard-steps">
             </ul>
             <div class="progress" >
                 <div class="progress-bar progress-bar-striped active" role="progressbar" >

                      </div>
             </div>
             <div class="tab-content">
                 <div class="tab-pane" id="tab">

                 </div>
             </div>
         </div>
     <div id="main-content" class="page-mailbox centered">
         <ul id="pregunta"></ul>
     </div>
{%csrf_token%}
 </section>
     <div class="row finalizo">
         <div class="col-sm-12"><h3>Test</h3></div>
         <div class="col-sm-12">¡Test realizado satisfactoriamente!: </div>
         <div class="col-sm-12">
            <p>Gracias por completar el Test, el mismo te ayudara a encontrar las oportunidades perfectas para ti.</p>
         </div>
     </div>
     <div class="row error">
         <div class="col-sm-12"><h3>Test</h3></div>
         <div class="col-sm-12">¡Error!: </div>
         <div class="col-sm-12">
            <p>Lo lamentamos hubo un error, debes comenzar nuevamente.</p>
         </div>
     </div>
<style>
    .wizard-progress.wizard-progress-lg{
        font-size: 14px;
        height: auto;
        line-height: 30px;
    }
    html .wizard-progress .wizard-steps li, html.dark .wizard-progress .wizard-steps li{
        min-width: 0px;
        visibility: hidden;
    }
    .wizard-progress .row {
        height: auto;
    }
    .wizard-progress .row div {
        height: 30px;
    }
    .wizard-progress .row .col-sm-3 {
        text-align:  center;
    }
    .wizard-progress .row input[type=radio]{
        margin: 0px;
        line-height:30px;
    }

            .tab-content>.tab-pane{
                display:block;
                max-height: 0;
                opacity:0;
                overflow: hidden;
                -webkit-transition: all 1s;
                  -moz-transition: all 1s;
                  -ms-transition: all 1s;
                  -o-transition: all 1s;
                  transition: all 1s;
            }
            .tab-content>.active{
                opacity: 1;
                max-height: 250px;
            }
</style>

<script>
    var JSPreguntas = function () {
        this.cargar = function(){
            $.ajax({
                type:"GET",
                url:"{%url 'disc-preguntas-estudiante' %}",
                processData: false,
                contentType: false,
                error: function(x){
                    console.log(x);
                },
                success: function(preguntas){
                    $.each(preguntas, function(i, pregunta) {
                        $(".wizard-steps").append(
                                '<li'+(i==0 ? ' class="active"':"")+'>'+
                                    '<a href="#tab'+i+'" data-toggle="tab"></a>'+
                                '</li>'
                        );
                        $(".tab-content").append(
                                '<div class="tab-pane '+(i==0 ? 'active':'')+'" id="tab'+i+'" data-id="'+pregunta.id+'"' +
                                ' data-info="'+i+'">'+
                                    '<div class = "row">'+
                                        '<div class = "col-sm-12">'+pregunta.descripcion+'</div>'+
                                    '</div>'+
                                    '<div class = "row">'+
                                        '<div class = "col-sm-6"></div>'+
                                        '<div class = "col-sm-3">Más</div>'+
                                        '<div class = "col-sm-3">Menos</div>'+
                                    '</div>'+
                                '</div>'
                        );
                        $.each(pregunta.respuestas, function(j, respuesta) {
                            $(".tab-content #tab"+i).append(
                                    '<div class = "row">'+
                                        '<div class = "col-sm-6">'+respuesta.descripcion+'</div>'+
                                        '<div class = "col-sm-3"><input type = "radio" name = "mas'+pregunta.id+'" value = "'+respuesta.id+'"></div>'+
                                        '<div class = "col-sm-3"><input type = "radio" name = "menos'+pregunta.id+'" value = "'+respuesta.id+'"></div>'+
                                    '</div>'
                            );
                        });
                        $(".tab-content #tab"+i).append('</ul></li>');
                    });
                    $('.wizard-progress').bootstrapWizard({
                        tabClass: 'wizard-steps',
                        onTabShow: function( tab, navigation, index ) {
                            var $total = navigation.find('li').length - 1;
                            var $current = index;
                            var $percent = Math.floor(( $current / $total ) * 100);

                            $('#wizard').find('.progress-bar').css({ 'width': $percent + '%' });
                            $current >= $total ?
                                $("#btn-guardar").show() :
                                    $("#btn-guardar").hide();
                            return false;
                        }
                        }, 5000);

                    //$(".tab-pane.active").on("click", "input", function(){

                },
            });

        },
        this.enviar_respuesta = function(preg, resp_mas, resp_menos){
            var form = new FormData();
            form.append('p', preg);
            form.append('r_mas', resp_mas);
            form.append('r_menos', resp_menos);
            form.append('csrfmiddlewaretoken',$('[name="csrfmiddlewaretoken"]').val());
            $.ajax({
                type:"POST",
                url:"{%url 'disc-respuesta-estudiante' %}",
                data: form,
                processData: false,
                contentType: false,
                error: function(x){
                    console.log(x.responseText);
                },
                success: function(data){
                    if(data != '0'){
                         $('#btn-cerrar').click();

                    }
                    console.log(data);
                },
            });


        }
        this.finalizar_test = function(finalizo){
            var form = new FormData();
            form.append('f', finalizo);
            form.append('csrfmiddlewaretoken',$('[name="csrfmiddlewaretoken"]').val());
            $.ajax({
                type:"POST",
                url:"{%url 'disc-finalizo-estudiante' %}",
                data: form,
                processData: false,
                contentType: false,
                error: function(x){
                    console.log(x.responseText);
                },
                success: function(data){
                    if(data == "1"){
                        $('#wizard').hide();
                        $('.finalizo').show();
                        $('#btn-guardar').hide();
                        $('#btn-cancelar').hide();
                        $('#btn-cerrar').show();
                        $('#preguntas-alert').hide();
                    }
                    else if(data == "-1"){
                        $('#wizard').hide();
                        $('.error').show();
                        $('#btn-guardar').hide();
                        $('#btn-cancelar').show();
                    }
                    console.log(data);

                },
            });
        }
    }
    var Preguntas = new JSPreguntas();
    $(function () {
        Preguntas.cargar();

        fnIniciarModelPreguntas();
        $(".tab-content").on("click", ".tab-pane.active input", function(){
            if($(this).is("[name^=mas]:checked")){
                            $(this).parents(".tab-pane").find("[name^=menos]").each(function() {
                                $(this).attr("disabled",false);
                            })
                            $(this).parents(".row").find("[name^=menos]").attr("disabled", true);
                        }else {
                            $(this).parents(".tab-pane").find("[name^=mas]").each(function() {
                                $(this).attr("disabled",false);
                            })
                            $(this).parents(".row").find("[name^=mas]").attr("disabled", true);
                        }
            if ( $(this).parents(".tab-pane").find("[name^=mas]:checked").length > 0 &&
                    $(this).parents(".tab-pane").find("[name^=menos]:checked").length > 0){
                Preguntas.enviar_respuesta($(this).parents(".tab-pane").data("id"),
                                                           $(this).parents(".tab-pane").find("[name^=mas]:checked").val(),
                                                           $(this).parents(".tab-pane").find("[name^=menos]:checked").val());
                $('.wizard-progress').bootstrapWizard('next');
                if($(this).parents(".tab-pane").data("info") == ($(".wizard-steps li").length -1)){
                    $('#btn-guardar').removeAttr("disabled");
                }
            }

        });
        $('#btn-comenzar').click(function(){
            $('.introduccion').hide();
            $('#btn-comenzar').hide();
            $('#wizard').show();
        });
        $('#btn-guardar').click(function(){
           Preguntas.finalizar_test(0); //calcula el patron
//            $('#wizard').hide();
//            $('.finalizo').show();
//            $('#btn-guardar').hide();
//            $('#btn-cancelar').hide();
//            $('#btn-cerrar').show();
        });
        $('#btn-cancelar').click(function(){
            Preguntas.finalizar_test(-1); // cancela y borra todas las respuestas hasta ahora del estudiante
            $('#btn-cerrar').click();
        });


    });


</script>
